#!/usr/bin/env node

"use strict";

const Blah = require("../lib")
    , Fs = require("fs")
    , Logger = require("bug-killer")
    , Tilda = require("tilda")
    , Package = require("../package")
    , Typpy = require("typpy")
    ;

/*!
 * log
 *
 * @name log
 * @function
 * @param {Error} err The error.
 * @param {String} data The info message.
 * @return {undefined}
 */
function log(err, data) {
    if (Typpy(err) === "array") {
        return err.forEach(c => {
            log(c);
        });
    }
    if (err) { return Logger.log(err.message || err, "error"); }
    if (!data) { return; }
    Logger.log(data, "info");
}

new Tilda(`${__dirname}/../package.json`, {
    actions: [{
        name: "init"
      , desc: "Inits the .blah directory."
    }],
    options: [{
        opts: ["b", "bump-version"]
      , desc: "Bumps the package.json version."
      , type: String
    }, {
        opts: ["r", "readme"]
      , desc: "Creates the README.md file."
    }, {
        opts: ["g", "gitignore"]
      , desc:  "Creates the .gitignore file."
    }, {
        opts: ["l", "license"]
      , desc: "Generates a LICENSE file with copyright information."
      , name: "license"
      , type: String
    }, {
        opts: ["d", "docs"]
      , desc: "Generates the markdown documentation (DOCUMENTATION.md) for input file."
      , name: "path"
    }, {
        opts: ["c", "contributing"]
      , desc: "Generates the CONTRIBUTING.md."
    }]
  , examples: [
        "blah --readme      # generates README.md"
      , "blah --gitignore   # generates .gitignore"
      , "blah --license mit # writes the MIT license in the LICENSE file"
      , "blah --docs index.js # generates DOCUMENTATION.md from index.js, parsing JSDoc comments"
      , "blah --bump-version major # bumps the major field of version, in package.json file"
    ]
  , notes: "Happy Blahing!"
}).on("init", a => {
    let blh = new Blah();
    return blh.init(err => log(err, `Initialized blah in ${blh.path}/.blah/`));
}).main(a => {
    if (process.argv.length === 2) {
        return a.displayHelp();
    }
    let blh = new Blah();

    // Create the readme file
    if (a.options.readme.is_provided) {
        blh.readme(err => log(err, "Generated README.md"));
    }

    // Create the license file
    if (a.options.license.is_provided) {
        blh.license(a.options.license.value, err => log(err, "Generated the LICENSE file."));
    }

    // Create the .gitignore file
    if (a.options.gitignore.is_provided) {
        blh.gitignore(err => log(err, "Generated the .gitignore file."));
    }

    // Generate documentation
    if (a.options.docs.is_provided) {
        blh.docs(a.options.docs.value, err => log(err, "Generated DOCUMENTATION.md."));
    }

    // Bump version
    if (a.options.b.is_provided) {
        blh.version(a.options.b.value, err => log(err, `Bumped the ${a.options.b.value} version.`));
    }

    // Generate CONTRIBUTING.md
    if (a.options.contributing.is_provided) {
        blh.contributing(err => log(err, "Generated CONTRIBUTING.md"));
    }
});
